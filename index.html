<!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SBX CIS Smart Invoicing & Deduction Checker</title>

  <!-- Google Fonts: Montserrat -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- React + ReactDOM (UMD) -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

  <!-- TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --sbx-blue:#2563eb;
      --sbx-blue-hover:#1d4ed8;
      --sbx-ink:#111827;
      --sbx-bg:#f9fafb;
      --sbx-card:#ffffff;
      --sbx-border:#e5e7eb;
    }
    body {
      font-family: 'Montserrat', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--sbx-ink);
      background: var(--sbx-bg);
    }
    .step-dot { height:8px; width:8px; border-radius:9999px; }
    .sbx-btn { background-color: var(--sbx-blue); color:#fff; transition: background-color .2s ease; }
    .sbx-btn:hover { background-color: var(--sbx-blue-hover); }
    .sbx-btn-dark { background-color: var(--sbx-ink); color:#fff; transition: background-color .2s ease; }
    .sbx-btn-dark:hover { background-color:#000; }

    .sbx-btn-print { background-color:#004aac; color:#fff; transition: background-color .2s ease; }
    .sbx-btn-print:hover { background-color:#003080; }

    /* Print: ONLY the invoice area prints, one A4 page */
    @media print {
      @page { size: A4; margin: 12mm; }
      html, body { height: auto !important; }
      body * { visibility: hidden !important; }
      #printable, #printable * { visibility: visible !important; }
      #printable {
        position: absolute;
        left: 0; top: 0;
        width: 190mm !important;         /* inner width to stay on one page */
        padding: 0 !important;
        margin: 0 !important;
        box-shadow: none !important;
        background: #fff !important;
      }
      table, tr, td, th { page-break-inside: avoid !important; }
    }
  </style>
</head>
<body class="bg-gray-50">
  <div id="root" class="max-w-7xl mx-auto p-4 md:p-8"></div>

  <script type="text/babel">
    const currency = (n) =>
      new Intl.NumberFormat("en-GB", { style: "currency", currency: "GBP", maximumFractionDigits: 2 })
        .format(isFinite(n) ? n : 0);

    const clampMoney = (v) => {
      const n = parseFloat(String(v || "").replace(/,/g, ""));
      return isFinite(n) ? Math.max(0, n) : 0;
    };

    const VAT_RATE = 0.2;

    const Badge = ({children}) => (
      <span className="inline-flex items-center rounded-full bg-blue-50 px-3 py-1 text-xs font-semibold text-blue-700 ring-1 ring-inset ring-blue-200">
        {children}
      </span>
    );

    const Stepper = ({step}) => (
      <div className="flex items-center gap-3">
        <div className="step-dot" style={{background: step>1 ? '#16a34a' : (step===1 ? '#2563eb' : '#e5e7eb')}}></div>
        <div className={"text-sm " + (step===1?'font-semibold':'')}>1) Who you're invoicing</div>
        <svg width="14" height="14" viewBox="0 0 20 20" aria-hidden="true"><path d="M7 5l5 5-5 5" fill="none" stroke="#cbd5e1" strokeWidth="2"/></svg>
        <div className="step-dot" style={{background: step>2 ? '#16a34a' : (step===2 ? '#2563eb' : '#e5e7eb')}}></div>
        <div className={"text-sm " + (step===2?'font-semibold':'')}>2) What you're charging</div>
        <svg width="14" height="14" viewBox="0 0 20 20" aria-hidden="true"><path d="M7 5l5 5-5 5" fill="none" stroke="#cbd5e1" strokeWidth="2"/></svg>
        <div className="step-dot" style={{background: step===3 ? '#2563eb' : '#e5e7eb'}}></div>
        <div className={"text-sm " + (step===3?'font-semibold':'')}>3) Results & Invoice</div>
      </div>
    );

    function App(){
      const [step, setStep] = React.useState(1);

      // Step 1 — context
      const [youVat, setYouVat] = React.useState(true);
      const [customerVat, setCustomerVat] = React.useState(true);
      const [endUser, setEndUser] = React.useState(false);
      const [withinCIS, setWithinCIS] = React.useState(true);

      // Step 2 — amounts + job meta
      const [jobType, setJobType] = React.useState("General building");
      const [jobTypeOther, setJobTypeOther] = React.useState("");
      const [showJobOnInvoice, setShowJobOnInvoice] = React.useState(true);
      const [labour, setLabour] = React.useState("");
      const [materials, setMaterials] = React.useState("");
      const [other, setOther] = React.useState("");
      const [cisStatus, setCisStatus] = React.useState("net20");

      // Step 3 — invoice meta & parties
      const today = new Date().toISOString().slice(0,10);
      const [fromName, setFromName] = React.useState("Your Trading Name");
      const [fromAddr1, setFromAddr1] = React.useState("");
      const [fromAddr2, setFromAddr2] = React.useState("");
      const [fromCity, setFromCity] = React.useState("");
      const [fromPost, setFromPost] = React.useState("");
      const [fromVat, setFromVat] = React.useState("");
      const [billTo, setBillTo] = React.useState("Customer Name");
      const [siteAddr1, setSiteAddr1] = React.useState("");
      const [siteAddr2, setSiteAddr2] = React.useState("");
      const [siteCity, setSiteCity] = React.useState("");
      const [sitePost, setSitePost] = React.useState("");
      const [invNo, setInvNo] = React.useState("INV-001");
      const [invDate, setInvDate] = React.useState(today);
      const [bankName, setBankName] = React.useState("");
      const [bankAcc, setBankAcc] = React.useState("");
      const [bankSort, setBankSort] = React.useState("");
      const [payRef, setPayRef] = React.useState("Invoice #");

      const labourVal = React.useMemo(()=>clampMoney(labour), [labour]);
      const materialsVal = React.useMemo(()=>clampMoney(materials), [materials]);
      const otherVal = React.useMemo(()=>clampMoney(other), [other]);

      // Rules
      const drcApplies = withinCIS && youVat && customerVat && !endUser;   
      const chargeVat = youVat && !drcApplies;                              
      const subtotal = labourVal + materialsVal + otherVal;
      const vatAmount = chargeVat ? subtotal * 0.2 : 0;
      const totalToInvoice = subtotal + vatAmount;

      const cisRate = React.useMemo(()=> cisStatus==="gross" ? 0 : (cisStatus==="net30" ? 0.30 : 0.20), [cisStatus]);
      const cisDeduction = withinCIS ? (labourVal * cisRate) : 0;
      const expectedTakeHome = totalToInvoice - cisDeduction;
      const drcCustomerVatInfo = drcApplies ? subtotal * 0.2 : 0;

      const reset = () => {
        setStep(1);
        setYouVat(true); setCustomerVat(true); setEndUser(false); setWithinCIS(true);
        setJobType("General building"); setJobTypeOther(""); setShowJobOnInvoice(true);
        setLabour(""); setMaterials(""); setOther(""); setCisStatus("net20");
        setFromName("Your Trading Name"); setFromAddr1(""); setFromAddr2(""); setFromCity(""); setFromPost(""); setFromVat("");
        setBillTo("Customer Name"); setSiteAddr1(""); setSiteAddr2(""); setSiteCity(""); setSitePost("");
        setInvNo("INV-001"); setInvDate(today);
        setBankName(""); setBankAcc(""); setBankSort(""); setPayRef("Invoice #");
      };

      const copyLines = () => {
        const rows = [];
        if(labourVal>0) rows.push(`Labour\t${currency(labourVal)}`);
        if(materialsVal>0) rows.push(`Materials & consumables\t${currency(materialsVal)}`);
        if(otherVal>0) rows.push(`Other charges\t${currency(otherVal)}`);
        rows.push(`Subtotal\t${currency(subtotal)}`);
        if(chargeVat) rows.push(`VAT @ 20%\t${currency(vatAmount)}`);
        rows.push(`Total to invoice\t${currency(totalToInvoice)}`);
        if(withinCIS && cisRate>0) rows.push(`CIS deduction (${Math.round(cisRate*100)}%)\t- ${currency(cisDeduction)}`);
        if(withinCIS) rows.push(`Expected amount you’ll receive\t${currency(expectedTakeHome)}`);
        navigator.clipboard.writeText(rows.join("\n")).then(()=>alert("Invoice lines copied to clipboard."));
      };

      const openEmailDraft = () => {
        const subject = `Invoice ${invNo || ""} from ${fromName || "Subcontractor"}`.trim();
        const body = `Hi,\n\nPlease find attached invoice ${invNo || ""} dated ${invDate || ""}.\n\nRegards,\n${fromName || ""}`;
        const mailto = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        window.location.href = mailto;
      };

      return (
        <div className="space-y-6">
          {/* ... steps 1 & 2 unchanged for brevity ... */}

          {/* Step 3 — Results row, then Invoice */}
          {step===3 ? (
            <div className="space-y-8">
              {/* ... Figures & VAT cards unchanged ... */}

              {/* Invoice section */}
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                {/* Inputs ... unchanged */}

                {/* Invoice (printable only) */}
                <div id="printable" className="bg-white rounded-2xl shadow p-6 border border-gray-100">
                  <h2 className="text-lg font-semibold mb-3">Invoice</h2>

                  <div className="rounded-2xl border border-gray-200 p-6 bg-white">
                    {/* invoice content here... */}
                  </div>
                </div>

                {/* Actions outside printable */}
                <div className="mt-3 flex flex-wrap gap-3">
                  <button className="px-4 py-2 rounded-lg sbx-btn-print" onClick={()=>window.print()}>Print</button>
                  <button className="px-4 py-2 rounded-lg sbx-btn-dark" onClick={openEmailDraft}>Open email draft</button>
                  <button className="px-4 py-2 rounded-lg bg-white border border-gray-200" onClick={copyLines}>Copy invoice lines</button>
                </div>
                <p className="text-xs text-gray-500 mt-2">
                  Use <b>Print</b> → “Save as PDF”, then attach it to your email.
                </p>
              </div>
            </div>
          ) : null}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
